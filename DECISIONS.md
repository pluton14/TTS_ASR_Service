# Технические решения

## Выбор Open-Source моделей

### TTS (Синтез речи)
**Выбрано: gTTS (Google Text-to-Speech)**

**Обоснование:**
- Высокое качество синтеза речи с естественными голосами
- Простая интеграция с FastAPI и WebSocket стримингом
- Минимальные зависимости и простота настройки
- Надежная работа в Docker контейнерах
- Хорошая производительность для демонстрационных целей

**Миграция с pyttsx3:**
- **Изначальный выбор**: pyttsx3 с espeak backend был выбран для автономной работы
- **Проблема**: pyttsx3 имел проблемы в Docker окружении без звуковой системы
- **Решение**: Переход на gTTS для надежного синтеза речи
- **Компромисс**: Теперь требует интернет-соединения, но обеспечивает лучшее качество

**Альтернативы, которые рассматривались:**
- **pyttsx3 + espeak**: Хорошо для автономной работы, но проблематично в Docker
- **Tacotron2/NeMo**: Слишком тяжелые для CPU-only инференса, требуют GPU
- **Coqui TTS**: Более сложная настройка, лучше подходит для продакшена с GPU

### ASR (Автоматическое распознавание речи)
**Выбрано: OpenAI Whisper (base.en)**

**Обоснование:**
- Современная точность распознавания английской речи
- Хорошая производительность на CPU (хотя медленнее GPU)
- Отличная обработка различных аудио форматов и качества
- Встроенная поддержка предобработки и нормализации аудио
- Хорошо документированный API и простая интеграция

**Альтернативы, которые рассматривались:**
- **DeepSpeech**: Устаревшая модель, низкая точность
- **Wav2Vec2**: Более сложная настройка, требует тонкой настройки для оптимальных результатов
- **AssemblyAI/Rev.ai**: Облачные решения, требуют интернет и API ключи

## Архитектурные решения

### Микросервисная архитектура
**Решение: Отдельные контейнеры для TTS, ASR и Gateway**

**Преимущества:**
- Независимое масштабирование и развертывание
- Технологическая изоляция (разные ML фреймворки)
- Четкое разделение ответственности
- Упрощенное тестирование и отладка
- Изоляция сбоев

### Протоколы связи
**TTS Сервис:**
- WebSocket для реального времени стриминга (`ws://tts:8082/ws/tts`)
- HTTP POST для простых запросов (`POST /api/tts`)

**ASR Сервис:**
- HTTP POST для обработки файлов (`POST /api/stt/bytes`)

**Gateway:**
- WebSocket прокси для TTS (`ws://gateway:8000/ws/tts`)
- HTTP echo endpoint (`POST /api/echo-bytes`)

### Аудио формат
**Решение: 16-bit PCM, моно, настраиваемые частоты дискретизации**

**Обоснование:**
- Стандартный формат, поддерживаемый всеми аудио библиотеками
- Эффективен для стриминга (без накладных расходов на сжатие)
- Легко обрабатывается и конвертируется
- Совместим с большинством моделей обработки речи

## Детали реализации

### Реализация стриминга
**TTS Стриминг:**
- Фиксированный размер чанка (1024 байта по умолчанию)
- Стриминг в реальном времени без буферизации всего аудио
- Правильная финализация потока с маркерами окончания
- Обработка ошибок для прерываний потока

**Обработка аудио:**
- Автоматическая передискретизация до целевых частот дискретизации
- Конвертация стерео в моно при необходимости
- Нормализация аудио для согласованных уровней
- Правильная конвертация PCM формата

### Обработка ошибок
- Структурированное логирование в JSON формате
- Комплексная обработка исключений
- Graceful degradation при сбоях сервисов
- Четкие сообщения об ошибках для потребителей API

### Управление конфигурацией
- Конфигурация на основе переменных окружения
- Отдельные настройки для каждого сервиса
- Конфигурация, дружественная к Docker
- Health check endpoints для мониторинга

## Вызовы и решения

### Вызов 1: Производительность CPU
**Проблема:** Модель Whisper медленная на CPU
**Решение:** 
- Использована whisper-base.en (меньшая модель)
- Оптимизирована предобработка аудио
- Приемлемо для демонстрационных целей
- Добавлена обработка таймаутов для длинного аудио

### Вызов 2: Совместимость аудио форматов
**Проблема:** Разные аудио форматы и частоты дискретизации
**Решение:**
- Реализован надежный пайплайн предобработки аудио
- Автоматическое определение и конвертация форматов
- Поддержка различных входных форматов
- Стандартизированный PCM вывод

### Вызов 3: Надежность стриминга
**Проблема:** WebSocket соединения могут быть нестабильными
**Решение:**
- Реализовано управление соединениями
- Правильная обработка ошибок и логика переподключения
- Маркеры финализации потока
- Обработка таймаутов

## Что не работало из коробки

### Инициализация TTS движка
- **Проблема:** pyttsx3 имел проблемы в Docker окружении без звуковой системы
- **Решение:** Переход на gTTS, который надежно работает в контейнерах
- **Реализация:** Добавлен ffmpeg в Dockerfile для обработки аудио gTTS

### Загрузка модели Whisper
- **Проблема:** Загрузка модели может быть медленной при первом запуске
- **Решение:** Предварительная загрузка моделей в Docker build или использование монтирования томов
- **Примечание:** В продакшене модели должны быть предварительно кэшированы

### Обработка аудио форматов
- **Проблема:** Различные аудио форматы требуют разной обработки
- **Решение:** Реализован комплексный пайплайн предобработки аудио
- **Улучшение:** Можно добавить поддержку большего количества форматов (MP3, AAC, и т.д.)

## Будущие улучшения (TODO/Дорожная карта)

### Оптимизации производительности
- [ ] GPU поддержка для более быстрого Whisper инференса
- [ ] Квантизация моделей для снижения использования памяти
- [ ] Кэширование для часто запрашиваемого TTS
- [ ] Пакетная обработка для множественных аудио файлов

### Улучшения функциональности
- [ ] Поддержка нескольких языков
- [ ] Опции настройки голоса
- [ ] Endpoints конвертации аудио форматов
- [ ] Стриминг аудио в реальном времени с микрофона

### Готовность к продакшену
- [ ] Комплексные unit и интеграционные тесты
- [ ] Мониторинг производительности и метрики
- [ ] Балансировка нагрузки и масштабирование
- [ ] Улучшения безопасности (аутентификация, ограничение скорости)

### Улучшения DevOps
- [ ] Kubernetes манифесты развертывания
- [ ] CI/CD пайплайн
- [ ] Автоматизированное тестирование
- [ ] Мониторинг и алертинг

## Требования к ресурсам

### Требования к CPU
- **Минимум:** 2 ядра, 4GB RAM
- **Рекомендуется:** 4 ядра, 8GB RAM
- **Для продакшена:** 8+ ядер, 16GB+ RAM

### Требования к хранилищу
- **Модели:** ~500MB для whisper base.en
- **Логи:** Переменные в зависимости от использования
- **Аудио кэш:** Опционально, зависит от стратегии кэширования

### Требования к сети
- **Внутренняя:** Низкая задержка между сервисами
- **Внешняя:** Зависит от паттернов использования клиентов
- **Пропускная способность:** Аудио стриминг требует стабильного соединения